# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

# Global configuration
nameOverride: ""
fullnameOverride: ""

# Envoy Gateway configuration
envoy:
  replicaCount: 1
  
  image:
    repository: envoyproxy/envoy
    tag: v1.31-latest
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8080
    annotations: {}
  
  # Backend configuration (Directory API)
  backend:
    # Address of Directory API server
    # Example: dir-dir-dev-argoapp-apiserver.dir-dev-dir.svc.cluster.local
    address: ""
    port: 8888
    # Connection timeout
    timeout: 30s
  
  # SPIFFE integration for mTLS with Directory
  spiffe:
    enabled: true
    # SPIFFE ID will be: spiffe://{trustDomain}/ns/{namespace}/sa/envoy-gateway
    # Assigned automatically by SPIRE
    
    # Trust domain (must match SPIRE deployment)
    trustDomain: example.org
    
    # SPIRE controller className (must match SPIRE Controller Manager)
    className: dir-spire
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Admin interface (for debugging)
  admin:
    enabled: true
    port: 9901

# Authorization Server configuration
authServer:
  replicaCount: 1
  
  # Image configuration
  # Override these values to use custom images (e.g., development branches)
  # image:
  #   repository: ghcr.io/agntcy/envoy-authz-dev
  #   tag: feat-feat-github-auth-ad4a58e
  #   pullPolicy: IfNotPresent
  image:
    repository: ghcr.io/agntcy/envoy-authz
    tag: v0.1.0
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 9002
  
  # Service configuration
  config:
    listenAddress: ":9002"
    logLevel: info
    defaultProvider: github
  
  # RBAC (Role-Based Access Control) Configuration
  authorization:
    # Default role assigned to authenticated users with no explicit role assignment
    # Set to empty string ("") to deny by default
    # Example: "reader"
    defaultRole: ""
    
    # User deny list (highest priority - blocks access even if user has a role)
    # Format: "github:username" or "username"
    # Example: ["github:blocked-user", "banned-account"]
    userDenyList: []
    
    # Role definitions
    # Each role specifies:
    #   - allowedMethods: List of API methods or "*" for wildcard
    #   - users: List of GitHub usernames assigned to this role
    #   - orgs: List of GitHub organizations assigned to this role
    #
    # Available API Methods (use full gRPC path format):
    #
    # StoreService (Content Storage):
    #   - /store.StoreService/Push              # Write objects
    #   - /store.StoreService/Pull              # Read objects
    #   - /store.StoreService/Lookup            # Get object metadata
    #   - /store.StoreService/Delete            # Delete objects
    #   - /store.StoreService/PushReferrer      # Write referrers
    #   - /store.StoreService/PullReferrer      # Read referrers
    #
    # SyncService (Node Synchronization):
    #   - /store.SyncService/CreateSync                   # Create sync operation
    #   - /store.SyncService/ListSyncs                    # List all syncs
    #   - /store.SyncService/GetSync                      # Get sync status
    #   - /store.SyncService/DeleteSync                   # Delete sync
    #   - /store.SyncService/RequestRegistryCredentials   # Request credentials
    #
    # RoutingService (DHT Operations):
    #   - /routing.RoutingService/Publish        # Publish to DHT
    #   - /routing.RoutingService/Unpublish      # Remove from DHT
    #   - /routing.RoutingService/Search         # Search DHT
    #   - /routing.RoutingService/List           # List DHT records
    #
    # PublicationService (Publication Management):
    #   - /routing.PublicationService/CreatePublication  # Create publication
    #   - /routing.PublicationService/ListPublications   # List publications
    #   - /routing.PublicationService/GetPublication     # Get publication details
    #
    # SearchService (Record Search):
    #   - /search.SearchService/SearchCIDs       # Search by CID
    #   - /search.SearchService/SearchRecords    # Search records
    #
    # SignService (Cryptographic Signing):
    #   - /sign.SignService/Sign                 # Sign data
    #   - /sign.SignService/Verify               # Verify signature
    #
    # NamingService (Name Resolution):
    #   - /naming.NamingService/GetVerificationInfo  # Get verification info
    #
    # EventService (Event Streaming):
    #   - /events.EventService/Listen            # Listen to events
    #
    roles:
      # Example: Admin role with full access
      # admin:
      #   allowedMethods:
      #     - "*"  # Wildcard = all methods
      #   users:
      #     - "github:alice"
      #     - "bob"  # "github:" prefix is optional
      #   orgs:
      #     - "agntcy"
      
      # Example: Reader role with limited access
      # reader:
      #   allowedMethods:
      #     - "/store.StoreService/Pull"
      #     - "/store.StoreService/Lookup"
      #     - "/store.StoreService/PullReferrer"
      #   users:
      #     - "github:charlie"
      #   orgs:
      #     - "contributors"
      
      # Example: Writer role with push/pull access
      # writer:
      #   allowedMethods:
      #     - "/store.StoreService/Push"
      #     - "/store.StoreService/Pull"
      #     - "/store.StoreService/Lookup"
      #   users: []
      #   orgs:
      #     - "developers"
  
  # GitHub provider configuration
  github:
    enabled: true
    cacheTTL: 5m
    apiTimeout: 10s
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Ingress configuration (optional)
ingress:
  enabled: false
  className: nginx
  host: ""
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt
    external-dns.alpha.kubernetes.io/hostname: ""
    # gRPC backend configuration (required for dirctl client over HTTPS)
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
    nginx.ingress.kubernetes.io/grpc-backend: "true"
  tls:
    enabled: true
    secretName: ""

# Service account
serviceAccount:
  create: true
  name: ""
  annotations: {}

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  fsGroup: 65532

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 65532
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}
