# Example configuration with multiple cronjobs
# This demonstrates how to configure multiple dirctl cronjobs

# Global config
global:
  cronjob:
    failedJobsHistoryLimit: 10
    successfulJobsHistoryLimit: 10
    concurrencyPolicy: 'Forbid'

# Image config
image:
  repository: ghcr.io/agntcy/dir-ctl
  tag: latest
  pullPolicy: IfNotPresent
  pullSecrets: []

# CronJobs configuration
cronjobs:
  # Search cronjob
  search:
    enabled: true
    schedule: '* * * * *'
    args:
      - 'search'

  # Lookup cronjob
  lookup:
    enabled: true
    schedule: '* * * * *'
    args:
      - 'info'
      - 'baeareiesad3lyuacjirp6gxudrzheltwbodtsg7ieqpox36w5j637rchwq'

  # Push cronjob
  push:
    enabled: true
    schedule: '* * * * *'
    args:
      - 'push'
      - '/examples/record.json'
    volumes:
      - name: record-json
        configMap:
          name: example-record
          items:
            - key: record.json
              path: examples/record.json
    volumeMounts:
      - name: record-json
        mountPath: /examples/record.json
        subPath: examples/record.json
        readOnly: true

  # Import cronjob - sync from MCP registry every 6 hours
  import-mcp:
    enabled: false
    schedule: '0 */6 * * *'  # Every 6 hours
    args:
      - 'import'
      - '--type=mcp'
      - '--url=https://registry.modelcontextprotocol.io/v0.1'
    env:
      # Import-specific environment variables can be added here
      # - name: DIRECTORY_CLIENT_SERVER_ADDRESS
      #   value: dir-apiserver.dir-server.svc.cluster.local:8888

# SPIRE configuration for workload identity
spire:
  enabled: false
  trustDomain: example.org
  
  # SPIRE controller className for ClusterSPIFFEID matching
  # 
  # REQUIRED: The className field is mandatory for ClusterSPIFFEID resources.
  # The SPIRE controller manager uses className to match ClusterSPIFFEID resources
  # with the appropriate SPIRE installation. Without this field, the controller
  # will ignore the ClusterSPIFFEID and no workload registration will occur,
  # causing authentication failures and preventing workloads from starting.
  # 
  # The className must match the SPIRE installation's className.
  # 
  # Default: "dir-spire" (matches standard SPIRE installation convention).
  # If your SPIRE installation uses a different className, override this value.
  # If not specified, falls back to "<namespace>-spire" (e.g., "my-namespace-spire").
  # 
  # IMPORTANT: Ensure this matches your SPIRE Controller Manager's className.
  # For standard installations, SPIRE is deployed in the "spire" namespace with
  # className "dir-spire". Verify with:
  #   kubectl get deployment -n spire spire-server -o yaml | grep className
  # 
  # See: https://github.com/spiffe/spire-controller-manager/blob/main/docs/clusterspiffeid-crd.md
  className: "dir-spire"
  
  # Use SPIFFE CSI driver for workload attestation (recommended)
  # 
  # When true (recommended):
  #   - Uses SPIFFE CSI driver for proper workload registration
  #   - Workload registration happens synchronously before pod starts
  #   - SPIRE agent issues X.509-SVID with URI SAN before pod begins
  #   - Eliminates "certificate contains no URI SAN" authentication errors
  #   - No race conditions during authentication
  #   - Production-ready, reliable identity injection
  # 
  # When false (legacy/debugging only):
  #   - Uses hostPath to mount SPIRE agent socket
  #   - Workload registration happens asynchronously via ClusterSPIFFEID
  #   - Pod may try to authenticate before registration completes
  #   - May cause intermittent authentication failures
  #   - Only use for debugging or when CSI driver is unavailable
  # 
  # Requires: SPIFFE CSI driver deployed in cluster
  # See: https://github.com/spiffe/spiffe-csi
  useCSIDriver: true
  
  federation: []
    # # Config: https://github.com/spiffe/spire-controller-manager/blob/main/docs/clusterfederatedtrustdomain-crd.md
    # - trustDomain: dir-cluster
    #   bundleEndpointURL: https://0.0.0.0:8081
    #   bundleEndpointProfile:
    #     type: https_web

# Additional environment variables (applied to all cronjobs)
env:
  - name: DIRECTORY_CLIENT_SERVER_ADDRESS
    value: dir-apiserver.dir-server.svc.cluster.local:8888
  - name: DIRECTORY_CLIENT_AUTH_MODE
    value: '' # Options: "token", "x509", "jwt", or "" for no auth
  - name: DIRECTORY_CLIENT_JWT_AUDIENCE
    value: '' # Required if using JWT auth
  - name: DIRECTORY_CLIENT_SPIFFE_TOKEN
    value: '' # Required if using token auth

# Config maps config (shared across all cronjobs)
configMaps:
  - name: example-record
    data:
      record.json: |
        {
          "name": "directory.agntcy.org/cisco/marketing-strategy-v3",
          "version": "v3.0.0",
          "schema_version": "0.7.0",
          "description": "Research agent for Cisco's marketing strategy.",
          "authors": [
            "Cisco Systems"
          ],
          "created_at": "2025-03-19T17:06:37Z",
          "annotations": {
            "key": "value"
          },
          "skills": [
            {
              "name": "natural_language_processing/natural_language_generation/text_completion",
              "id": 10201
            },
            {
              "name": "natural_language_processing/analytical_reasoning/problem_solving",
              "id": 10702
            }
          ],
          "locators": [
            {
              "type": "docker_image",
              "url": "https://ghcr.io/agntcy/marketing-strategy"
            }
          ],
          "domains": [
            {
              "name": "life_science/biotechnology"
            }
          ],
          "modules": [
            {
              "name": "runtime/model",
              "id": 303,
              "data": {
                "models": [
                  {
                    "provider": "openai",
                    "model": "gpt-4",
                    "api_base": "https://api.openai.com/v1",
                    "env_vars": [
                      {
                        "name": "OPENAI_API_KEY",
                        "description": "OpenAI API key for authentication",
                        "required": true
                      },
                      {
                        "name": "OPENAI_ORG_ID",
                        "description": "OpenAI organization ID",
                        "required": false,
                        "default_value": ""
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }

# Service account config
serviceAccount:
  create: false
  annotations: {}
  name: ''

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 65532
  readOnlyRootFilesystem: true

# Default resource configuration (can be overridden per cronjob)
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 50m
    memory: 64Mi

# Default volumes (can be extended per cronjob)
volumes: []

# Default volume mounts (can be extended per cronjob)
volumeMounts: []
