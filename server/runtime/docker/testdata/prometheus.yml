global:
  scrape_interval: 5s
  evaluation_interval: 5s
  scrape_timeout: 2s

scrape_configs:
  # Probe containers with exposed ports for A2A agents
  - job_name: 'a2a-agent-probe'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: status
            values: ['running']
    
    relabel_configs:
      # Skip prometheus and blackbox containers
      - source_labels: [__meta_docker_container_name]
        regex: '/(prometheus|blackbox-exporter|json-exporter)'
        action: drop
      
      # Only keep targets with a public (published) port
      - source_labels: [__meta_docker_port_public]
        regex: '.+'
        action: keep
      
      # Build probe URL using container IP and public port
      - source_labels: [__meta_docker_network_ip, __meta_docker_port_public]
        regex: '(.+);(.+)'
        replacement: 'http://host.docker.internal:${2}/.well-known/agent-card.json'
        target_label: __param_target

      # Set url label to public URL
      - source_labels: [__meta_docker_network_ip, __meta_docker_port_public]
        regex: '(.+);(.+)'
        replacement: 'http://localhost:${2}'
        target_label: url
      
      # Route through blackbox exporter
      - target_label: __address__
        replacement: json-exporter:7979
        # replacement: blackbox-exporter:9115
    
    metrics_path: /probe
    params:
      module: [a2a_agent]
    
    metric_relabel_configs:
      # Drop instance and job labels from stored metrics
      - action: labeldrop
        regex: 'instance|job'
