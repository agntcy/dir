# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

---
name: Trigger integrations
description: Run the integration tests in CSIT repository
inputs:
  github-token:
    description: "GitHub token"
    required: false
    default: ${{ github.token }}

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0

    - name: Get latest tags and versions
      id: tags
      shell: bash
      run: |
        VERSION_TAG=$(git tag --sort=-creatordate --list 'v*.*.*' | head -1)

        echo "CHART_TAG=$VERSION_TAG" >> $GITHUB_OUTPUT
        echo "IMAGE_TAG=$VERSION_TAG" >> $GITHUB_OUTPUT

    - name: Trigger integration tests
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
              owner: 'agntcy',
              repo: 'csit',
              workflow_id: 'test-integrations.yaml',
              ref: 'main',
              inputs: {
                  skip_directory_test: false,
                  override_directory_image_tag: '${{ steps.tags.outputs.IMAGE_TAG }}',
                  override_directory_chart_tag: '${{ steps.tags.outputs.CHART_TAG }}',
              },
          });
