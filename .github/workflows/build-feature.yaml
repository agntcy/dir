# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

name: Build Feature Branch

# This workflow allows building Docker images and Helm charts from feature branches
# for testing before creating a release. It can be manually triggered from any branch.
#
# Usage:
# 1. Push your feature branch to GitHub
# 2. Go to Actions → "Build Feature Branch" → "Run workflow"
# 3. Select your branch and provide custom tags (or leave empty for auto-generated)
# 4. Use the generated tags in agntcy-deployment for testing

on:
  workflow_dispatch:
    inputs:
      component:
        required: false
        type: string
        description: "Component suffix for images/charts (e.g., 'dev' creates dir-apiserver-dev, dir-dev/helm-charts). Default: 'dev'"
        default: "dev"
      image_tag:
        required: false
        type: string
        description: "Image tag (leave empty for auto: feat-<branch>-<short-sha>)"
        default: ""
      chart_version:
        required: false
        type: string
        description: "Chart version (leave empty for auto: 0.0.0-test-<short-sha>)"
        default: ""
      push_images:
        required: false
        type: boolean
        default: true
        description: "Push images to registry (if false, only builds charts)"

permissions:
  contents: read
  packages: write

jobs:
  prepare:
    name: Prepare Tags
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tags.outputs.image_tag }}
      chart_version: ${{ steps.tags.outputs.chart_version }}
      image_repo: ${{ steps.tags.outputs.image_repo }}
      image_name_suffix: ${{ steps.tags.outputs.image_name_suffix }}
      chart_path: ${{ steps.tags.outputs.chart_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Generate tags
        id: tags
        shell: bash
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]')
          COMPONENT="${{ inputs.component }}"
          
          if [ -z "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="feat-${BRANCH_NAME}-${SHORT_SHA}"
          else
            IMAGE_TAG="${{ inputs.image_tag }}"
          fi
          
          if [ -z "${{ inputs.chart_version }}" ]; then
            CHART_VERSION="0.0.0-test-${SHORT_SHA}"
          else
            CHART_VERSION="${{ inputs.chart_version }}"
          fi
          
          # Generate image repo and suffix for component separation
          IMAGE_REPO="ghcr.io/agntcy"
          if [ -n "${COMPONENT}" ]; then
            IMAGE_NAME_SUFFIX="-${COMPONENT}"
            CHART_PATH="dir-${COMPONENT}"
          else
            IMAGE_NAME_SUFFIX=""
            CHART_PATH="dir"
          fi
          
          echo "image_tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "image_repo=${IMAGE_REPO}" >> "$GITHUB_OUTPUT"
          echo "image_name_suffix=${IMAGE_NAME_SUFFIX}" >> "$GITHUB_OUTPUT"
          echo "chart_path=${CHART_PATH}" >> "$GITHUB_OUTPUT"
          echo "Generated image tag: ${IMAGE_TAG}"
          echo "Generated chart version: ${CHART_VERSION}"
          echo "Image name suffix: ${IMAGE_NAME_SUFFIX}"
          echo "Chart path: ${CHART_PATH}"

  build-images:
    name: Build Images
    if: ${{ inputs.push_images == true }}
    needs:
      - prepare
    uses: ./.github/workflows/reusable-build.yaml
    with:
      image_repo: ${{ needs.prepare.outputs.image_repo }}
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      image_name_suffix: ${{ needs.prepare.outputs.image_name_suffix }}
      push: true

  build-charts:
    name: Build Charts
    needs:
      - prepare
    uses: ./.github/workflows/reusable-release-helm.yaml
    with:
      image_repo: ${{ needs.prepare.outputs.image_repo }}
      release_tag: ${{ needs.prepare.outputs.chart_version }}
      chart_path: ${{ needs.prepare.outputs.chart_path }}

  summary:
    name: Summary
    needs:
      - prepare
      - build-images
      - build-charts
    runs-on: ubuntu-latest
    # Allow summary even if build-images was skipped (when push_images=false)
    if: ${{ always() && needs.prepare.result == 'success' && needs.build-charts.result == 'success' }}
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ needs.prepare.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Chart Version:** \`${{ needs.prepare.outputs.chart_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Component:** \`${{ inputs.component }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage in agntcy-deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**config.json:**" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '{' >> $GITHUB_STEP_SUMMARY
          echo '  "chart_repo": "ghcr.io",' >> $GITHUB_STEP_SUMMARY
          echo '  "chart_name": "agntcy/${{ needs.prepare.outputs.chart_path }}/helm-charts/dir",' >> $GITHUB_STEP_SUMMARY
          echo '  "chart_version": "${{ needs.prepare.outputs.chart_version }}"' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**values.yaml:**" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          echo 'image:' >> $GITHUB_STEP_SUMMARY
          echo '  repository: ghcr.io/agntcy/dir-apiserver${{ needs.prepare.outputs.image_name_suffix }}' >> $GITHUB_STEP_SUMMARY
          echo '  tag: ${{ needs.prepare.outputs.image_tag }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

