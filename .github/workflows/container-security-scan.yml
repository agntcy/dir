# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0
name: Container Security Scan

on:
  # Nightly scan on main branch only; manual dispatch allowed.
  schedule:
    - cron: "0 3 * * *" # Daily at 03:00 UTC (runs on default branch context: main)
  workflow_dispatch:
    inputs:
      image-tag:
        required: false
        type: string
        description: "Override tag for repo images (empty for latest)"

permissions:
  contents: read
  security-events: write # for uploading SARIF
  actions: read
  issues: write # create issues for critical CVEs

jobs:
  resolve-tag:
    name: Resolve image tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Resolve image tag
        id: resolve
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.image-tag }}" ]; then
            echo "version=${{ inputs.image-tag }}" >> $GITHUB_OUTPUT
          else
            OWNER=${GITHUB_REPOSITORY%%/*}
            REPO_NAME=${GITHUB_REPOSITORY#*/}
            TAG_VERSION=$(gh api graphql \
              -f query='
                query($owner: String!, $repo: String!, $tagCount: Int!) {
                  repository(owner: $owner, name: $repo) {
                    refs(refPrefix: "refs/tags/", first: $tagCount, orderBy: {field: TAG_COMMIT_DATE, direction: DESC}) {
                      nodes { name }
                    }
                  }
                }
              ' \
              -F owner=$OWNER -F repo=$REPO_NAME -F tagCount=100 \
              --jq 'first(.data.repository.refs.nodes[] | select(.name | contains("/") | not).name)'
            )
            echo "version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          fi

  trivy-scan:
    name: Trivy Scan
    runs-on: ubuntu-latest
    needs: [resolve-tag]
    strategy:
      fail-fast: false
      matrix:
        # Single source of truth: add/remove images here
        # Repo images use resolved tag, external images specify version or digest
        image:
          - ghcr.io/${{ github.repository_owner }}/dir-apiserver:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/${{ github.repository_owner }}/dir-ctl:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/${{ github.repository_owner }}/dir-reconciler:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/${{ github.repository_owner }}/dir-runtime-discovery:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/${{ github.repository_owner }}/dir-runtime-server:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/${{ github.repository_owner }}/envoy-authz:${{ needs.resolve-tag.outputs.version }}
          - ghcr.io/project-zot/zot:v2.1.14
          - ghcr.io/spiffe/spire-server:1.14.1
          - ghcr.io/spiffe/spire-agent:1.14.1
          - docker.io/bitnami/postgresql@sha256:c47e54a69b39aa97d4405d68ea02bf2ffe06b646748e2ddf9c761416ead6acd5
    steps:
      - name: Set image name
        id: image-name
        run: |
          # Extract image name from full reference (e.g., ghcr.io/owner/image:tag -> image)
          IMAGE_NAME=$(echo "${{ matrix.image }}" | sed -E 's|.*/||; s|[:@].*||')
          echo "name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Scan image
        uses: aquasecurity/trivy-action@9ab158e8597f3b310480b9a69402b419bc03dbd5 # v0.24.0
        with:
          image-ref: ${{ matrix.image }}
          github-pat: ${{ secrets.GITHUB_TOKEN }}
          format: sarif
          output: trivy-${{ steps.image-name.outputs.name }}.sarif
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH,MEDIUM"
          ignore-unfixed: true

      - name: Export image metadata
        run: echo "${{ matrix.image }}" > trivy-${{ steps.image-name.outputs.name }}.meta

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@1b1aada464948af03b950897e5eb522f92603cc2 # v3.26.9
        with:
          sarif_file: trivy-${{ steps.image-name.outputs.name }}.sarif
          category: trivy-${{ steps.image-name.outputs.name }}

      - name: Upload report artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: trivy-report-${{ steps.image-name.outputs.name }}
          path: |
            trivy-${{ steps.image-name.outputs.name }}.sarif
            trivy-${{ steps.image-name.outputs.name }}.meta
          retention-days: 7

  summarize:
    name: Summarize Results
    needs: [trivy-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: trivy-artifacts

      - name: Generate summary
        run: |
          chmod +x .github/workflows/scripts/security/generate_trivy_summary.sh
          .github/workflows/scripts/security/generate_trivy_summary.sh

      - name: Fail if critical vulns found (optional gate)
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          set -e
          found=$(grep -R "CRITICAL" -c trivy-artifacts || true)
          if [ "${found}" != "0" ]; then
            echo "Critical vulnerabilities detected. (Gate currently informational.)" >&2
          fi

      - name: Create GitHub issues for critical CVEs
        if: ${{ github.event_name != 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Installing dependencies for issue creation script";
          npm init -y >/dev/null 2>&1 || true
          npm install @octokit/rest@21 glob >/dev/null 2>&1
          node .github/workflows/scripts/security/create_critical_cve_issues.js
