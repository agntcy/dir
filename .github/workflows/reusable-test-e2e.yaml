# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

name: Test E2E

on:
  workflow_call:
    inputs:
      image_repo:
        required: true
        type: string
        description: "Image repo to use."
      image_tag:
        required: true
        type: string
        description: "Image tag to use."
      enable_coverage:
        required: false
        type: boolean
        default: false
        description: "Whether to collect and upload E2E coverage to Codecov."
    secrets:
      CODECOV_TOKEN:
        description: "Codecov token for uploading coverage reports"
        required: false

jobs:
  e2e:
    name: Test ${{ matrix.label }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - task: test:e2e:local
            label: "Local"
            coverage-files: ".coverage/e2e/local-cli.out,.coverage/e2e/local-client.out,.coverage/e2e/server.out"
          - task: test:e2e:network
            label: "Network"
            coverage-files: ".coverage/e2e/network.out,.coverage/e2e/server.out"
          - task: test:e2e:spire
            label: "Federation"
            coverage-files: ".coverage/e2e/server.out"
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Login to ghcr.io
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: notused
          password: ${{ secrets.GITHUB_TOKEN  }}

      - name: Setup Taskfile
        shell: bash
        run: sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin

      - name: Setup Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: "1.25.7"
          cache-dependency-path: "**/*.sum"
          cache: true # NOTE: Default value, just to be explicit

      - name: Download artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          path: tmp/artifacts
          merge-multiple: true

      - name: Download coverage image artifacts
        if: ${{ inputs.enable_coverage }}
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
        with:
          path: tmp/coverage-artifacts
          pattern: "*-coverage"
          merge-multiple: true

      - name: Load images to local Docker registry
        run: |
          for image_archive in tmp/artifacts/*.tar; do
            docker load --input "$image_archive"
          done
          docker images

      - name: Load coverage images to local Docker registry
        if: ${{ inputs.enable_coverage }}
        run: |
          for image_archive in tmp/coverage-artifacts/*.tar; do
            docker load --input "$image_archive"
          done
          docker images

      - name: Load compiled dirctl binary
        run: |
          mkdir ./bin
          cp tmp/artifacts/dirctl ./bin/dirctl
          chmod +x ./bin/dirctl

      - name: Run end-to-end tests
        env:
          IMAGE_REPO: ${{ inputs.image_repo }}
          IMAGE_TAG: ${{ inputs.image_tag }}
          E2E_COMPILE_OUTPUT_DIR: tmp
          E2E_COVERAGE_ENABLED: ${{ matrix.task != 'test:e2e:spire' && inputs.enable_coverage && 'true' || 'false' }}
        run: |
          # Use a random cluster name to avoid conflicts in concurrent runs.
          # Kind cluster names must be lowercase and can contain only letters and numbers.
          export KIND_CLUSTER_NAME=test-$(openssl rand -base64 12 | tr -dc 'a-z0-9')
          task ${{ matrix.task }}

      - name: Process E2E coverage
        if: ${{ inputs.enable_coverage && matrix.task != 'test:e2e:spire' }}
        run: |
          task test:e2e:coverage:process

      - name: Upload E2E coverage to Codecov
        if: ${{ inputs.enable_coverage && matrix.task != 'test:e2e:spire' }}
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          files: ${{ matrix.coverage-files }}
          flags: e2e-${{ matrix.label }}
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}
