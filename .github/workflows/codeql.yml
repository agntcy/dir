# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '42 5 * * 6'

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: go
          build-mode: manual
        - language: javascript-typescript
          build-mode: none
        - language: python
          build-mode: none
        # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Log language being analyzed
      run: |
        echo "üîç Starting CodeQL analysis for: ${{ matrix.language }}"
        echo "Build mode: ${{ matrix.build-mode }}"

    # Add any setup steps before running the `github/codeql-action/init` action.
    # This includes steps like installing compilers or runtimes (`actions/setup-node`
    # or others). This is typically only required for manual builds.
    # - name: Setup runtime (example)
    #   uses: actions/setup-example@v1

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        queries: +security-extended,security-and-quality
        config: |
          name: "CodeQL Config"
          queries:
            - uses: security-extended
            - uses: security-and-quality
          paths-ignore:
            - "**/*.pb.go"
            - "**/mock_*.go"
            - "**/testdata/**"
            - "**/vendor/**"

    # If the analyze step fails for one of the languages you are analyzing with
    # "We were unable to automatically build your code", modify the matrix above
    # to set the build mode to "manual" for that language. Then modify this step
    # to build your code.
    # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
    # üìö See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
    - name: Set up Go
      if: matrix.language == 'go'
      uses: actions/setup-go@v5
      with:
        go-version: '1.23.2'
        cache: true

    - name: Install Task
      if: matrix.language == 'go'
      uses: arduino/setup-task@v2
      with:
        version: 3.x
        repo-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install buf CLI
      if: matrix.language == 'go'
      shell: bash
      run: |
        # Install buf for protobuf generation
        curl -sSL "https://github.com/bufbuild/buf/releases/latest/download/buf-$(uname -s)-$(uname -m)" -o /tmp/buf
        sudo mv /tmp/buf /usr/local/bin/buf
        sudo chmod +x /usr/local/bin/buf

    - name: Set up Node.js
      if: matrix.language == 'javascript-typescript'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '**/package*.json'

    - name: Set up Python
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install JavaScript/TypeScript dependencies
      if: matrix.language == 'javascript-typescript'
      shell: bash
      run: |
        echo "üì¶ Installing JavaScript/TypeScript dependencies..."
        # Install dependencies for JavaScript SDK
        if [ -f "sdk/dir-js/package.json" ]; then
          cd sdk/dir-js
          npm ci || npm install
          cd ../..
        fi
        # Install dependencies for examples
        if [ -f "sdk/examples/example-js/package.json" ]; then
          cd sdk/examples/example-js
          npm ci || npm install
          cd ../../..
        fi
        echo "‚úÖ JavaScript/TypeScript dependencies installed"

    - name: Install Python dependencies
      if: matrix.language == 'python'
      shell: bash
      run: |
        echo "üì¶ Installing Python dependencies..."
        # Install dependencies for Python SDK
        if [ -f "sdk/dir-py/pyproject.toml" ]; then
          cd sdk/dir-py
          pip install -e . || echo "Failed to install Python SDK"
          cd ../..
        fi
        # Install dependencies for examples
        if [ -f "sdk/examples/example-py/requirements.txt" ]; then
          cd sdk/examples/example-py
          pip install -r requirements.txt || echo "Failed to install example requirements"
          cd ../../..
        fi
        echo "‚úÖ Python dependencies installed"

    - name: Run manual build steps
      if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        if [ "${{ matrix.language }}" == "go" ]; then
          echo "üî® Building Go project for CodeQL analysis..."

          # First try using Task if available
          if command -v task &> /dev/null; then
            echo "üì¶ Installing dependencies with Task..."
            if task deps; then
              echo "‚úÖ Task deps completed"
            else
              echo "‚ö†Ô∏è Task deps failed, trying alternative approach"
            fi

            echo "üîß Generating code with Task..."
            if task gen; then
              echo "‚úÖ Code generation completed"
            else
              echo "‚ö†Ô∏è Code generation failed, continuing..."
            fi

            echo "üßπ Tidying dependencies with Task..."
            if task deps:tidy; then
              echo "‚úÖ Dependencies tidied"
            else
              echo "‚ö†Ô∏è Deps tidy failed, continuing..."
            fi

            echo "üî® Compiling CLI with Task..."
            if task cli:compile; then
              echo "‚úÖ CLI compilation completed"
            else
              echo "‚ö†Ô∏è CLI compile failed, trying manual build..."
            fi
          fi

          # Fallback: Manual Go build for each module
          echo "üîç Building all Go modules manually to ensure CodeQL can analyze them..."
          find . -name "go.mod" -not -path "./vendor/*" -not -path "./.git/*" -print0 | while IFS= read -r -d '' gomod; do
            module_dir=$(dirname "$gomod")
            echo "üì¶ Building module: $module_dir"

            pushd "$module_dir" > /dev/null

            # Download dependencies
            if go mod download; then
              echo "‚úÖ Downloaded dependencies for $module_dir"
            else
              echo "‚ö†Ô∏è Failed to download dependencies for $module_dir"
            fi

            # Build all packages in the module
            if go build -v ./...; then
              echo "‚úÖ Built packages in $module_dir"
            else
              echo "‚ö†Ô∏è Failed to build some packages in $module_dir, but continuing..."
            fi

            popd > /dev/null
          done

          echo "‚úÖ Go build process completed"
        else
          echo "‚ùå Manual build mode not supported for language: ${{ matrix.language }}"
          exit 1
        fi

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:${{matrix.language}}"
