name: Import MCP Records

on:
  push:
    branches:
      - '852-sync-mcp-cards-from-external-mcp-registry'
  workflow_dispatch:
    inputs:
      import_config:
        description: 'JSON config path or content (default: .github/workflows/scripts/import-records.json)'
        required: false
      dry_run:
        description: 'Run in dry-run mode (default: false)'
        type: boolean
      rate_limit:
        description: 'LLM API requests per minute (default: 10)'
        type: number
      sign:
        description: 'Sign records after pushing with OIDC (default: true)'
        type: boolean
  schedule:
    - cron: '0 0 * * *'

jobs:
  import-mcp:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC signing with Sigstore
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.6"

      - name: Setup Taskfile
        shell: bash
        run: sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b ~/.local/bin

      - name: Build dirctl
        run: |
          task cli:compile
          ls -la bin/

      - name: Create Enricher Config
        run: |
          cat <<'EOF' > mcphost_ci.json
          {
            "mcpServers": {
              "dir-mcp-server": {
                "command": "bin/dirctl",
                "args": [
                  "mcp",
                  "serve"
                ],
                "env": {
                  "OASF_API_VALIDATION_SCHEMA_URL": "https://schema.oasf.outshift.com",
                  "AZURE_RESOURCE_NAME": "phoenix-project-agents",
                  "AZURE_API_VERSION": "2024-10-21",
                  "AZURE_API_KEY": "${AZURE_OPENAI_API_KEY}",
                  "AZURE_OPENAI_BASE_URL": "${AZURE_OPENAI_ENDPOINT}"
                }
              }
            },
            "model": "azure:gpt-4o",
            "max-steps": 10
          }
          EOF

      - name: Get GitHub OIDC Token
        id: oidc-token
        if: ${{ inputs.sign == true || (github.event_name == 'schedule') }}
        run: |
          OIDC_TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sigstore" | jq -r '.value')
          echo "::add-mask::$OIDC_TOKEN"
          echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: Import MCP Records
        env:
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          IMPORT_CONFIG: ${{ inputs.import_config || '.github/workflows/scripts/import-records.json' }}
          DRY_RUN: ${{ inputs.dry_run || 'true' }}
          RATE_LIMIT: ${{ inputs.rate_limit || '2' }}
          SIGN: ${{ inputs.sign || 'true' }}
          OIDC_TOKEN: ${{ steps.oidc-token.outputs.token }}
        run: |
          # Determine if IMPORT_CONFIG is a file path or direct JSON content
          if [ -f "$IMPORT_CONFIG" ]; then
            echo "Loading config from file: $IMPORT_CONFIG"
            CONFIG_CONTENT=$(cat "$IMPORT_CONFIG")
          else
            echo "Loading config from input string"
            CONFIG_CONTENT="$IMPORT_CONFIG"
          fi

          # Build optional flags
          DRY_RUN_FLAG=""
          if [[ "${DRY_RUN,,}" == "true" ]]; then
             DRY_RUN_FLAG="--dry-run"
          fi

          SIGN_FLAGS=""
          if [[ "${SIGN,,}" == "true" ]] && [ -n "$OIDC_TOKEN" ]; then
             SIGN_FLAGS="--sign --oidc-token=$OIDC_TOKEN --oidc-provider-url=https://token.actions.githubusercontent.com --oidc-client-id=https://github.com/${{ github.repository }}/.github/workflows/import-records.yaml@${{ github.ref }}"
          fi

          # base command array with rate limiting and debug enabled
          BASE_CMD=(bin/dirctl import --type=mcp --url=https://registry.modelcontextprotocol.io/v0.1 --enrich-config=mcphost_ci.json --enrich-rate-limit="$RATE_LIMIT" --force --debug)
          if [ -n "$DRY_RUN_FLAG" ]; then
            BASE_CMD+=("$DRY_RUN_FLAG")
          fi
          if [ -n "$SIGN_FLAGS" ]; then
            BASE_CMD+=($SIGN_FLAGS)
          fi

          # Get array length using jq
          LENGTH=$(echo "$CONFIG_CONTENT" | jq 'length')

          if [ -z "$LENGTH" ] || [ "$LENGTH" = "null" ]; then
             echo "Error: Invalid JSON configuration or not an array"
             exit 1
          fi

          for (( i=0; i<$LENGTH; i++ )); do
            echo "--- Processing Entry $((i+1)) ---"

            # Extract values using jq
            SEARCH=$(echo "$CONFIG_CONTENT" | jq -r ".[$i].search // empty")
            VERSION=$(echo "$CONFIG_CONTENT" | jq -r ".[$i].version // empty")
            UPDATED_SINCE=$(echo "$CONFIG_CONTENT" | jq -r ".[$i].updated_since // empty")

            # Build entry-specific arguments
            ENTRY_CMD=("${BASE_CMD[@]}")

            if [ -n "$SEARCH" ]; then
              ENTRY_CMD+=(--filter="search=$SEARCH")
            fi
            if [ -n "$VERSION" ]; then
              ENTRY_CMD+=(--filter="version=$VERSION")
            fi
            if [ -n "$UPDATED_SINCE" ]; then
              ENTRY_CMD+=(--filter="updated_since=$UPDATED_SINCE")
            fi

            echo "Running: ${ENTRY_CMD[*]}"
            "${ENTRY_CMD[@]}"
          done
