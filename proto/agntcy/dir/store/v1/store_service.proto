// Copyright AGNTCY Contributors (https://github.com/agntcy)
// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";

package agntcy.dir.store.v1;

import "agntcy/dir/store/v1/object.proto";
import "google/protobuf/empty.proto";

// Defines an interface for content-addressable storage
// service for objects.
//
// Max object size: 4MB (to fully fit in a single request)
// Max metadata size: 100KB
//
// Store service can be implemented by various storage backends,
// such as local file system, OCI registry, etc.
//
// Middleware should be used to control who can perform these RPCs.
// Policies for the middleware can be handled via separate service.
//
// Each operation is performed sequentially, meaning that
// for the N-th request, N-th response will be returned.
// If an error occurs, the stream will be cancelled.
service StoreService {
  // Push performs write operation for given object.
  rpc Push(stream PushRequest) returns (PushResponse);

  // Pull performs read operation for given object.
  rpc Pull(PullRequest) returns (stream PullResponse);

  // Lookup resolves basic metadata for the object.
  rpc Lookup(LookupRequest) returns (LookupResponse);

  // Remove performs delete operation for the object.
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  
  // PushReferrer performs write operation for object referrers.
  rpc PushReferrer(PushReferrerRequest) returns (PushReferrerResponse);

  // PullReferrer performs read operation for object referrers.
  rpc PullReferrer(PullReferrerRequest) returns (PullReferrerResponse);
}

message PushRequest {
  oneof payload {
    bytes chunk = 1;
    Object object = 2;
  }
}

message PushResponse {
  bool success = 1;
  optional string error_message = 2;
  ObjectRef object_ref = 3;
}

message PullRequest {
  ObjectRef object_ref = 1;
}

message PullResponse {
  bool success = 1;
  optional string error_message = 2;
  oneof payload {
    bytes chunk = 3;
    Object object = 4;
  }
}

message LookupRequest {
  ObjectRef object_ref = 1;
}

message LookupResponse {
  bool success = 1;
  optional string error_message = 2;
  Object object = 3;
}

message DeleteRequest {
  ObjectRef object_ref = 1;
}

message DeleteResponse {
  bool success = 1;
  optional string error_message = 2;
}

// PushReferrerRequest represents a record with optional OCI artifacts for push operations.
message PushReferrerRequest {
  // Object reference
  ObjectRef object_ref = 1;

  // Object referrer reference
  ObjectRef referrer_ref = 2;
}

// PushReferrerResponse
message PushReferrerResponse {
  // The push process result
  bool success = 1;
  
  // Optional error message if push failed
  optional string error_message = 2;
}

// PullReferrerRequest represents a record with optional OCI artifacts for pull operations.
message PullReferrerRequest {
  // Object reference
  ObjectRef object_ref = 1;

  // Object referrer type to be pulled
  // If not provided, all referrers will be pulled
  optional string referrer_type = 2;
}

// PullReferrerResponse is returned after successfully fetching a record referrer.
message PullReferrerResponse {
  // ObjectReferrer object associated with the object
  ObjectRef referrer_ref = 1;
}
