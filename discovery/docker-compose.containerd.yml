# Docker Compose for testing containerd runtime
#
# Requirements:
# - Linux host with containerd installed (not via Docker)
# - containerd socket at /run/containerd/containerd.sock
# - CNI configured with state at /var/lib/cni/results
#
# Usage:
#   nerdctl compose -f docker-compose.containerd.yml up -d
#
# Note: This is for testing on a Linux machine with standalone containerd.
# On macOS/Windows, containerd can be setup with Lima.
#
services:
  # ============================================================
  # etcd - Distributed key-value store
  # ============================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: etcd
    command:
      - etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --initial-advertise-peer-urls=http://etcd:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster=etcd0=http://etcd:2380
    networks:
      - discovery
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================================
  # Watcher - containerd runtime
  # ============================================================
  watcher:
    build: ./watcher
    volumes:
      # containerd socket (Linux only)
      - /run/containerd/containerd.sock:/run/containerd/containerd.sock:ro
      # CNI state directory for network info
      - /var/lib/cni/results:/var/lib/cni/results:ro
    environment:
      # etcd
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
      - ETCD_PREFIX=/discovery
      # Runtime
      - RUNTIME=containerd
      - CONTAINERD_SOCKET=/run/containerd/containerd.sock
      - CONTAINERD_NAMESPACE=default
      - CONTAINERD_CNI_STATE_DIR=/var/lib/cni/results
      - CONTAINERD_LABEL_KEY=discover
      - CONTAINERD_LABEL_VALUE=true
      - PYTHONUNBUFFERED=1
    depends_on:
      etcd:
        condition: service_healthy
    networks:
      - discovery

  # ============================================================
  # Server - HTTP API for querying discovered services
  # ============================================================
  server:
    build: ./server
    environment:
      # etcd
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
      - ETCD_PREFIX=/discovery
      # Server
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - PYTHONUNBUFFERED=1
    depends_on:
      etcd:
        condition: service_healthy
    networks:
      - discovery
    ports:
      - "8080:8080"

  # ============================================================
  # Example services - must have discover=true label
  # ============================================================
  service-1:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a

  service-2:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-b

  service-3:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a

  service-4:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-b

  service-5:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a
      - team-b

  # Service without discover label (NOT tracked)
  service-private:
    image: nginx:alpine
    container_name: service-private
    networks:
      - team-internal

networks:
  discovery:
    driver: bridge

  team-a:
    driver: bridge

  team-b:
    driver: bridge

  team-internal:
    driver: bridge
