services:
  # ============================================================
  # etcd - Distributed key-value store for service discovery data
  # ============================================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: etcd
    command:
      - etcd
      - --name=etcd0
      - --data-dir=/etcd-data
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
      - --initial-advertise-peer-urls=http://etcd:2380
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-cluster=etcd0=http://etcd:2380
    networks:
      - discovery
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================================
  # Watcher - Watches container runtime and syncs to etcd
  # ============================================================
  watcher:
    build: ./watcher
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # etcd
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
      - ETCD_PREFIX=/discovery
      # Runtime (docker, containerd, or kubernetes)
      - RUNTIME=docker
      - PYTHONUNBUFFERED=1
    depends_on:
      etcd:
        condition: service_healthy
    networks:
      - discovery

  # ============================================================
  # Server - HTTP API for querying discovered services
  # ============================================================
  server:
    build: ./server
    environment:
      # etcd
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
      - ETCD_PREFIX=/discovery
      # Server
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8080
      - PYTHONUNBUFFERED=1
    depends_on:
      etcd:
        condition: service_healthy
    networks:
      - discovery
    ports:
      - "8080:8080"

  # ============================================================
  # Example services - must be on discovery network to be tracked
  # ============================================================


  service-1:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a

  service-2:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-b

  # Service Internal - on team-a-internal, will be auto-connected to discovery
  service-3:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a

  service-4:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-b

  service-5:
    image: nginx:alpine
    labels:
      - "discover=true"
    networks:
      - team-a
      - team-b

  # Service Private - no discover label (NOT tracked, NOT auto-connected)
  service-private:
    image: nginx:alpine
    container_name: service-private
    networks:
      - team-internal

networks:
  # Discovery network - watcher lives here, services auto-connected
  discovery:
    driver: bridge

  team-a:
    driver: bridge

  team-b:
    driver: bridge

  team-internal:
    driver: bridge
